name: Train Model and Dockerize

on:
  push:
    paths:
      - 'MLProject/**'
  workflow_dispatch:

jobs:
  train-and-dockerize:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Miniconda
      uses: conda-incubator/setup-miniconda@v2
      with:
        environment-file: MLProject/conda.yaml
        activate-environment: mlflow-env
        auto-activate-base: false
        use-mamba: true

    - name: Install MLflow
      run: pip install mlflow

    - name: Train Model via Conda
      working-directory: MLProject
      run: |
        conda run -n mlflow-env python modelling.py

    - name: Cek isi folder mlruns
      run: |
        echo "Cek isi MLProject/mlruns/0:"
        ls -l MLProject/mlruns/0 || echo "âŒ Folder belum terisi"

    - name: Get latest run_id from MLflow
      id: get_run_id
      run: |
        echo "ðŸ”Ž Mencari run_id terakhir..."
        RUN_DIR=$(ls -td MLProject/mlruns/0/*/ 2>/dev/null | head -1)
        if [[ -z "$RUN_DIR" ]]; then
          echo "âŒ Tidak ada run ditemukan, proses dihentikan."
          exit 1
        fi
        RUN_ID=$(basename "$RUN_DIR")
        echo "âœ… Ditemukan RUN_ID: $RUN_ID"
        echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
        echo "MODEL_PATH=MLProject/mlruns/0/$RUN_ID/artifacts/model" >> $GITHUB_ENV

    - name: Debug folder run
      run: |
        echo "ðŸ“ Isi folder run:"
        ls -R MLProject/mlruns/0/${{ env.RUN_ID }}

    - name: Login to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Build Docker Image from MLflow Model
      run: |
        echo "ðŸ³ Building Docker Image from MODEL_PATH=${{ env.MODEL_PATH }}"
        mlflow models build-docker \
          -m "file://${{ env.MODEL_PATH }}" \
          --env-manager=local \
          -n "${{ secrets.DOCKERHUB_USERNAME }}/online_shopper_model:latest"

    - name: Push Docker Image to DockerHub
      run: |
        docker push "${{ secrets.DOCKERHUB_USERNAME }}/online_shopper_model:latest"

    - name: Simpan URL Docker ke tautan_dockerhub.txt
      run: |
        echo "https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/online_shopper_model" > MLProject/tautan_dockerhub.txt

    - name: Commit hasil tautan DockerHub
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Update tautan Docker Hub otomatis"
        file_pattern: 'MLProject/tautan_dockerhub.txt'
